@inject Services.IPlayersLoader players;
@inject Services.IProvincesLoader provinces;
@inject Services.IActionLoader actions;
@inject Services.IActivePlayer active;

@using Mode = GameSwitch.Mode;

@code{
    [Parameter] public State.Player? Player { get; set; }
    [Parameter] public bool IsActive { get; set; }
    [Parameter] public Action<Mode, State.Province?, State.Province?, State.Player?> Switch { get; set; } = ((a, x, y, z) => { });
    [Parameter] public bool Preview { get; set; }
    State.Province? OnClick(int clicked, State.Province? from)
    {
        if (!IsActive || from is State.Mountains)
        {
            return null;
        }
        if (from is null && provinces[clicked].IsControlledBy(Player!.Id))
        {
            return provinces[clicked];
        }
        if (from is null && provinces[clicked] is State.Land L1 && !L1.Occupied)
        {
            Switch(Mode.CmdPurchase, L1, L1, null);
            return null;
        }
        if (from?.Id != clicked)
        {
            Switch(Mode.CmdMove, from, provinces[clicked], null);
            return null;
        }
        if (from is State.Land)
        {
            Switch(Mode.CmdRecruit, from, from, null);
            return null;
        }
        return from;
    }
}
@{ 
    State.IProvinces prov = provinces;
    if (Preview)
    {
        var queue = actions.Where(x => x is Dynamics.Actions.ArmyOperation || x is Dynamics.Actions.PortRenewal);
        prov = queue.EndOfTurn(players, provinces, active.Id).Item3;
    }
}
<Map Width="1000" Height="1000" Provinces="@prov" OnClick="OnClick" FontSize="9"/>